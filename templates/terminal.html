<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AESCULAPIUS: OMEGA PROTOCOL</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/retro_style.css">
    <link rel="stylesheet" href="/static/fallout-theme.css">
    <script>
        const USER_ROLE = "{{ user_role }}";
        // Early theme initialization to prevent flash
        (function() {
            if (localStorage.getItem('themeMode') === 'fallout') {
                document.documentElement.classList.add('theme-fallout');
            }
        })();
    </script>
</head>
<body>

    <div class="monitor-casing">
        <div class="crt-screen">
            <div class="scanlines"></div>   
            <div class="crt-overlay"></div> 
            
            <div class="content-layer">
                
                <div class="panel control-panel" style="position: relative;">
                    
                    <div class="header-box">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div style="flex-grow: 1;">
                                <h1 style="font-size: 2.5rem;">AESCULAPIUS <span class="blink">_ V1.5.1 SECURE</span></h1>
                                <div class="user-badge">
                                    <div class="sub-header">USER: {{ user_name }} // ROLE: {{ user_role|upper }} // TERMINAL: 04-B</div>
                                </div>
                                
                                <div class="actions" style="margin-top: 15px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                    <!-- Search container with search mode toggle -->
                                    <div class="search-container">
                                        <button class="search-toggle-btn" id="searchToggleBtnMain" title="Search Patients"></button>
                                        <button class="search-mode-btn" id="searchModeBtn" title="Toggle search mode" style="display: none; margin-left: 5px;">BY NAME</button>
                                        <input type="text" class="search-input-main" id="searchInputMain" placeholder="QUERY..." style="display: none;">
                                        <div class="search-suggestions-main" id="searchSuggestionsMain"></div>
                                    </div>
                                    
                                    <!-- Theme Toggle Button -->
                                    <button class="btn" id="themeToggleBtnTerminal" title="Switch Interface Theme">THEME</button>
                                    
                                    {% if user_role in ['Manager'] %}
                                    <button id="toggleChaosEngineBtn" onclick="toggleSim()" class="btn danger-btn">TOGGLE CHAOS ENGINE</button>
                                    {% endif %}
                                    
                                    <a href="/api/export" target="_blank"><button class="btn">EXPORT DATA</button></a>
                                    
                                    {% if user_role in ['Registrar', 'Manager'] %}
                                    <button onclick="openModal('add')" class="btn">MANUAL ADMIT</button>
                                    {% endif %}
                                    
                                    <a href="/logout"><button class="btn" style="border-color: #555;">LOGOUT</button></a>
                                </div>
                            </div>
                            
                            <div class="hierarchy-container">
                                <div style="margin-bottom:5px; font-size:0.8rem; border-bottom:1px solid var(--color-red);">CLEARANCE LEVEL</div>
                                <div class="h-node {% if user_role == 'Manager' %}active-node{% endif %}">
                                    OBSERVER <br><span style="font-size:12px">[Full System Access]</span>
                                </div>
                                <div class="h-line">|</div>
                                <div class="h-node {% if user_role == 'Admin' %}active-node{% endif %}">
                                    DOCTOR <br><span style="font-size:12px">[Patient Data R/W]</span>
                                </div>
                                <div class="h-line">|</div>
                                <div class="h-node {% if user_role == 'Registrar' %}active-node{% endif %}">
                                    REGISTRAR <br><span style="font-size:12px">[Patient Admit Only]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="panel data-panel">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 5%;">ID</th>
                                    <th style="width: 5%;">STAT</th>
                                    <th style="width: 25%;">CODE NAME</th>
                                    <th style="width: 20%;">THREAT TYPE</th>
                                    <th style="width: 15%;">VITALS (HR/O2)</th>
                                    <th style="width: 20%;">LOCATION / DOC</th>
                                    <th style="width: 10%;">TIME</th>
                                    {% if user_role in ['Admin', 'Manager'] %}
                                    <th>OP</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody id="patientTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="patientModalOverlay" class="modal-overlay">
        <div class="modal-window">
            <h2 id="modalTitle"></h2>
            <div class="form-grid">
                <input type="hidden" id="subjectId">
                <input type="hidden" id="threatId">

                <label for="subjectName">SUBJECT NAME:</label>
                <input type="text" id="subjectName" placeholder="Format: Lastname, Firstname">

                <label for="assignedDoctor">ASSIGNED DOCTOR:</label>
                <select id="assignedDoctor"></select>

                <label for="assignedRoom">ASSIGNED ROOM:</label>
                <select id="assignedRoom"></select>
                
                <div class="full-width">
                    <div class="HRSPO2">
                        <label for="subjectHR">HEART RATE:</label> 
                        <input type="number" id="subjectHR" min="0" max="300">
                    </div>
                    <div class="HRSPO2">
                        <label for="subjectSPO2">SPO2 (%):</label> 
                        <input type="number" id="subjectSPO2" min="0" max="100">
                    </div>
                </div>

                <label style="grid-column: 1 / -1; text-align: left; color: var(--phosphor-primary);">THREAT LEVEL:</label>
                <div class="threat-carousel-wrapper" style="grid-column: 1 / -1;">
                    <button class="carousel-arrow left-arrow" onclick="scrollThreats(-1)">&#9664;</button>
                    <div id="threatCards" class="cards-container threat-carousel-inner">
                    </div>
                    <button class="carousel-arrow right-arrow" onclick="scrollThreats(1)">&#9654;</button>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button onclick="closeModal()" class="btn">CANCEL</button>
                <button id="modalSubmitButton" class="btn edit-btn"></button>
            </div>
        </div>
    </div>

    <script>
        // === THEME TOGGLE FUNCTIONALITY (TERMINAL) ===
        const themeToggleBtnTerminal = document.getElementById('themeToggleBtnTerminal');
        let isFalloutThemeActive = localStorage.getItem('themeMode') === 'fallout';

        function initializeThemeTerminal() {
            if (isFalloutThemeActive) {
                document.body.classList.add('theme-fallout');
                document.documentElement.classList.add('theme-fallout');
                updateThemeToggleButtonTerminalUI();
            }
        }

        function updateThemeToggleButtonTerminalUI() {
            if (isFalloutThemeActive) {
                themeToggleBtnTerminal.textContent = 'FALEWGASEM';
            } else {
                themeToggleBtnTerminal.textContent = 'THEME: DEFAULT';
            }
        }

        themeToggleBtnTerminal.addEventListener('click', function(e) {
            e.stopPropagation();
            isFalloutThemeActive = !isFalloutThemeActive;
            localStorage.setItem('themeMode', isFalloutThemeActive ? 'fallout' : 'default');
            
            if (isFalloutThemeActive) {
                document.body.classList.add('theme-fallout');
                document.documentElement.classList.add('theme-fallout');
            } else {
                document.body.classList.remove('theme-fallout');
                document.documentElement.classList.remove('theme-fallout');
            }
            
            updateThemeToggleButtonTerminalUI();
        });

        // Initialize theme on page load
        window.addEventListener('load', function() {
            initializeThemeTerminal();
        });

        // --- GLOBAL DATA STORAGE ---
        let allDoctors = [];
        let allRooms = [];
        let allThreats = [];
        let currentOffset = 0;
        const loadLimit = 100;
        let allLoadedPatients = [];
        let totalPatientCount = 0;
        let fetchIntervalId = null;

        // --- FETCH CYCLE WITH PAGINATION ---
        async function fetchUpdates() {
            try {
                const response = await fetch(`/api/data?offset=${currentOffset}&limit=${loadLimit}`);
                if(response.status === 403) { window.location.href = '/login'; return; }
                
                const data = await response.json();
                
                if (JSON.stringify(allThreats) !== JSON.stringify(data.threats)) {
                    allThreats = data.threats;
                    populateThreatCards();
                }
                allDoctors = data.doctors;
                allRooms = data.rooms;
                totalPatientCount = data.total_patients;
                
                // ONLY on initial load or when offset resets - don't concat infinitely
                if (currentOffset === 0) {
                    allLoadedPatients = data.patients;
                } else {
                    // When loading more, carefully append only new patients
                    allLoadedPatients = allLoadedPatients.concat(data.patients);
                }
                
                renderTable(allLoadedPatients);
                renderLoadMoreButton();
            } catch (e) {
                console.error("Connection lost", e);
            }
        }
        
        // Start interval and store ID for cleanup
        fetchIntervalId = setInterval(fetchUpdates, 3000);
        fetchUpdates();
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (fetchIntervalId) {
                clearInterval(fetchIntervalId);
            }
        });

        // --- LOAD MORE FUNCTIONALITY ---
        function renderLoadMoreButton() {
            const tbody = document.getElementById('patientTableBody');
            let loadMoreRow = document.getElementById('loadMoreRow');
            
            // Check if we have more data to load
            const hasMore = (currentOffset + loadLimit) < totalPatientCount;
            
            if (hasMore) {
                if (!loadMoreRow) {
                    loadMoreRow = document.createElement('tr');
                    loadMoreRow.id = 'loadMoreRow';
                    loadMoreRow.style.backgroundColor = 'rgba(51, 255, 51, 0.05)';
                    loadMoreRow.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            <button class="btn" onclick="loadMorePatients()" style="padding: 10px 30px;">LOAD MORE RECORDS</button>
                        </td>
                    `;
                    tbody.appendChild(loadMoreRow);
                }
            } else {
                if (loadMoreRow) {
                    loadMoreRow.remove();
                }
            }
        }
        
        function loadMorePatients() {
            currentOffset += loadLimit;
            // IMPORTANT: Reset allLoadedPatients on load-more to prevent infinite memory growth
            // We'll fetch fresh data instead of appending infinitely
            allLoadedPatients = [];
            fetchUpdates();
        }

        // --- RENDER TABLE WITH MEMORY OPTIMIZATION ---
        function renderTable(patients) {
            const tbody = document.getElementById('patientTableBody');
            
            // Clear old rows (except load-more button)
            const loadMoreRow = document.getElementById('loadMoreRow');
            if (loadMoreRow) {
                loadMoreRow.remove();
            }
            tbody.innerHTML = '';
            
            if(patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="padding:50px;">NO ACTIVE SIGNALS... SYSTEM STANDBY</td></tr>';
                return;
            }

            // Render max 100 rows at a time to prevent DOM bloat
            const maxRenderCount = 100;
            const renderPatients = patients.slice(0, maxRenderCount);

            renderPatients.forEach(p => {
                const row = document.createElement('tr');
                const safeData = encodeURIComponent(JSON.stringify(p));
                
                const color = p[3] || 'Green';
                row.className = 'row-' + color.toLowerCase();

                let actionsHtml = '';
                if (['Admin', 'Manager'].includes(USER_ROLE)) {
                    actionsHtml = `
                        <td>
                            <button class="mini-btn delete-btn" onclick="deletePatient(${p[0]}, event)">X</button>
                        </td>
                    `;
                    row.setAttribute('onclick', `openModal('edit', '${safeData}')`);
                }

                row.innerHTML = `
                    <td>${p[0]}</td>
                    <td><span class="status-dot ${p[3].toLowerCase()}"></span> ${p[3]}</td>
                    <td style="text-align:left; padding-left:20px;">${p[1]}</td>
                    <td>${p[2]}</td>
                    <td>${p[4]} BPM / ${p[5]}%</td>
                    <td>${p[7] || 'N/A'}<br><small style="opacity:0.7">${p[6] || 'Unassigned'}</small></td>
                    <td>${new Date(p[8]).toLocaleTimeString()}</td>
                    ${actionsHtml ? actionsHtml : ''}
                `;
                tbody.appendChild(row);
            });
            
            // Warn if table is larger than optimal
            if (patients.length > maxRenderCount) {
                const warningRow = document.createElement('tr');
                warningRow.innerHTML = `<td colspan="8" style="text-align:center; color: #ffff33; padding: 10px;">
                    Showing ${maxRenderCount} of ${patients.length} records. Use LOAD MORE or filters to manage data.
                </td>`;
                tbody.appendChild(warningRow);
            }
        }

        // --- MODAL MANAGEMENT ---
        let modalMode = 'add'; // 'add' or 'edit'

        function openModal(mode, encodedData = null) {
            modalMode = mode;
            const modal = document.getElementById('patientModalOverlay');
            document.getElementById('patientModalOverlay').style.display = 'flex';

            // Reset form
            document.getElementById('subjectId').value = '';
            document.getElementById('subjectName').value = '';
            document.getElementById('subjectHR').value = '';
            document.getElementById('subjectSPO2').value = '';
            document.getElementById('threatId').value = '';
            
            populateSelect('assignedDoctor', allDoctors);
            populateSelect('assignedRoom', allRooms);
            populateThreatCards();

            const submitButton = document.getElementById('modalSubmitButton');

            if (mode === 'add') {
                document.getElementById('modalTitle').innerText = ">> MANUAL ADMISSION FORM";
                document.getElementById('subjectName').value = "Unknown Subject";
                document.getElementById('subjectHR').value = 80;
                document.getElementById('subjectSPO2').value = 98;
                submitButton.innerText = "ADMIT SUBJECT";
                submitButton.onclick = submitAdd;
            } else {
                const p = JSON.parse(decodeURIComponent(encodedData));
                // p indexes: 0:ID, 1:Name, 4:HR, 5:SPO2, 9:ThreatID, 10:DocID, 11:RoomID
                document.getElementById('modalTitle').innerText = `>> EDIT RECORD [ID: ${p[0]}]`;
                
                document.getElementById('subjectId').value = p[0];
                document.getElementById('subjectName').value = p[1];
                document.getElementById('subjectHR').value = p[4];
                document.getElementById('subjectSPO2').value = p[5];

                populateSelect('assignedDoctor', allDoctors, p[10]);
                populateSelect('assignedRoom', allRooms, p[11]);
                selectThreatCard(p[9]);
                
                submitButton.innerText = "CONFIRM UPDATE";
                submitButton.onclick = submitEdit;
            }
        }

        function closeModal() {
            document.getElementById('patientModalOverlay').style.display = 'none';
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('patientModalOverlay');
                // Only close if modal is visible
                if (modal && modal.style.display === 'flex') {
                    closeModal();
                }
            }
        });

        async function submitAdd() {
            const body = {
                name: document.getElementById('subjectName').value || "Unknown Subject",
                doctor_id: document.getElementById('assignedDoctor').value,
                room_id: document.getElementById('assignedRoom').value,
                threat_id: document.getElementById('threatId').value,
                hr: document.getElementById('subjectHR').value,
                spo2: document.getElementById('subjectSPO2').value
            };

            if (!body.threat_id) {
                alert("ERROR: Threat Level must be selected.");
                return;
            }
            
            await fetch('/api/add_patient', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            closeModal();
            fetchUpdates();
        }

        async function submitEdit() {
            const body = {
                subject_id: document.getElementById('subjectId').value,
                name: document.getElementById('subjectName').value,
                doctor_id: document.getElementById('assignedDoctor').value,
                room_id: document.getElementById('assignedRoom').value,
                threat_id: document.getElementById('threatId').value,
                hr: document.getElementById('subjectHR').value,
                spo2: document.getElementById('subjectSPO2').value,
            };

             if (!body.threat_id) {
                alert("ERROR: Threat Level must be selected.");
                return;
            }

            const res = await fetch('/api/update_patient', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            
            if(res.ok) {
                closeModal();
                fetchUpdates();
            } else {
                alert("UPDATE FAILED: Access Denied or DB Error");
            }
        }

        // --- DELETE FUNCTION ---
        async function deletePatient(id, event) {
            event.stopPropagation(); // Prevent row click from triggering
            if(!confirm("CONFIRM DELETION of Subject " + id + "? This action is irreversible.")) return;
            
            const res = await fetch('/api/delete_patient', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ subject_id: id })
            });
            if(res.ok) fetchUpdates();
            else alert("DELETE FAILED: Access Denied");
        }

        // --- UI UTILS ---
        function populateSelect(elemId, items, selectedId = null) {
            const select = document.getElementById(elemId);
            select.innerHTML = '';
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.innerText = item.name;
                if (item.id == selectedId) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
        }
        
        function scrollThreats(direction) {
            const container = document.getElementById('threatCards'); // This is now threat-carousel-inner
            const scrollAmount = 110; // Adjusted from 150 (card width + gap)
            const glitchDuration = 200; // Milliseconds, should match animation duration

            if (container) {
                // Apply glitch effect
                container.classList.add('glitch-on-scroll');

                container.scrollBy({
                    left: direction * scrollAmount,
                    behavior: 'smooth'
                });

                // Remove glitch effect after animation duration
                setTimeout(() => {
                    container.classList.remove('glitch-on-scroll');
                }, glitchDuration);
            }
        }

        function populateThreatCards() {
            const container = document.getElementById('threatCards');
            if (!container) return;
            container.innerHTML = '';

            allThreats.forEach(threat => {
                const card = document.createElement('div');
                // Determine color class based on threat name (green by default)
                let colorClass = 'green';
                const name = threat.name.toLowerCase();
                
                if (name.includes('yellow') || name.includes('influenza') || name.includes('cold') || name.includes('mild')) {
                    colorClass = 'yellow';
                } else if (name.includes('red') || name.includes('critical') || name.includes('severe') || name.includes('heart') || name.includes('stroke')) {
                    colorClass = 'red';
                } else if (name.includes('black') || name.includes('death') || name.includes('fatal') || name.includes('necrotic')) {
                    colorClass = 'black';
                }
                
                card.className = `card ${colorClass}`;
                card.innerText = threat.name;
                card.onclick = () => selectThreatCard(threat.id);
                card.dataset.threatId = threat.id;
                container.appendChild(card);
            });
        }

        function selectThreatCard(threatId) {
            // Set the hidden input value
            document.getElementById('threatId').value = threatId;
            
            const container = document.getElementById('threatCards');
            const cards = container.querySelectorAll('.card');
            
            let found = false;
            cards.forEach(card => {
                const cardThreat = allThreats.find(t => t.name.toLowerCase() === card.innerText.toLowerCase());
                if (cardThreat && cardThreat.id === threatId) {
                    // Only add active if not already active, otherwise toggle
                    if (card.classList.contains('active')) {
                        // Already active - keep it active (no change needed)
                        card.classList.add('active');
                    } else {
                        card.classList.add('active');
                    }
                    found = true;
                } else {
                    card.classList.remove('active');
                }
            });
        }
        
        
        let isChaosEngineActive = localStorage.getItem('chaosEngineActive') === 'true';

        async function toggleSim() {
            const toggleButton = document.getElementById('toggleChaosEngineBtn');
            // Optimistically update UI
            isChaosEngineActive = !isChaosEngineActive;
            localStorage.setItem('chaosEngineActive', isChaosEngineActive);
            updateToggleButtonUI();

            // Send request to backend
            const response = await fetch('/api/toggle_sim', {method:'POST'});
            if (!response.ok) {
                // If backend call fails, revert UI state
                isChaosEngineActive = !isChaosEngineActive;
                localStorage.setItem('chaosEngineActive', isChaosEngineActive);
                updateToggleButtonUI();
                alert('Failed to toggle Chaos Engine status.');
            }
        }

        function updateToggleButtonUI() {
            const toggleButton = document.getElementById('toggleChaosEngineBtn');
            if (toggleButton) {
                if (isChaosEngineActive) {
                    toggleButton.textContent = 'CHAOS ENGINE ACTIVE';
                    toggleButton.classList.add('btn-active-warn');
                } else {
                    toggleButton.textContent = 'TOGGLE CHAOS ENGINE';
                    toggleButton.classList.remove('btn-active-warn');
                }
            }
        }

        // --- SPINBOX ARROW HANDLERS ---
        document.addEventListener('DOMContentLoaded', function() {
            updateToggleButtonUI();
            
            // Create spinbox buttons dynamically
            const spinboxDivs = document.querySelectorAll('.full-width > div');
            
            spinboxDivs.forEach((div, index) => {
                const input = div.querySelector('input[type="number"]');
                if (!input) return;
                
                // Create UP button
                const upBtn = document.createElement('div');
                upBtn.className = 'spinbox-btn spinbox-up';
                upBtn.textContent = '▲';
                upBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const maxVal = parseInt(input.max) || 300;
                    const currentVal = parseInt(input.value || 0);
                    input.value = Math.min(currentVal + 1, maxVal);
                    input.dispatchEvent(new Event('change'));
                });
                
                // Create DOWN button
                const downBtn = document.createElement('div');
                downBtn.className = 'spinbox-btn spinbox-down';
                downBtn.textContent = '▼';
                downBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const minVal = parseInt(input.min) || 0;
                    const currentVal = parseInt(input.value || 0);
                    input.value = Math.max(currentVal - 1, minVal);
                    input.dispatchEvent(new Event('change'));
                });
                
                // Add input validation for max constraint
                input.addEventListener('input', function() {
                    const maxVal = parseInt(this.max);
                    const minVal = parseInt(this.min) || 0;
                    let val = parseInt(this.value);
                    
                    if (val > maxVal) {
                        this.value = maxVal;
                    } else if (val < minVal) {
                        this.value = minVal;
                    }
                });
                
                // Add buttons to div
                div.appendChild(upBtn);
                div.appendChild(downBtn);
            });
        });

        // === DRAG AND DROP FOR ACTION BUTTONS ===
        const actionButtonsContainer = document.querySelector('.actions');
        let draggedButton = null;
        let dragOffsetX = 0;
        let initialPosition = 0;
        
        function initButtonDragDrop() {
            const buttons = actionButtonsContainer.querySelectorAll('a, button:not(.search-toggle-btn):not(.search-mode-btn), input[type="text"]:not(.search-input-main)');
            
            buttons.forEach(btn => {
                btn.draggable = false;
                btn.style.cursor = 'grab';
                btn.addEventListener('mousedown', startButtonDrag);
            });
        }
        
        function startButtonDrag(e) {
            // Only drag with left mouse button
            if (e.button !== 0) return;
            
            draggedButton = this;
            dragOffsetX = e.clientX - draggedButton.getBoundingClientRect().left;
            initialPosition = Array.from(actionButtonsContainer.children).indexOf(draggedButton);
            
            draggedButton.style.cursor = 'grabbing';
            draggedButton.style.opacity = '0.6';
            draggedButton.style.transform = 'scale(1.05)';
            
            document.addEventListener('mousemove', moveButton);
            document.addEventListener('mouseup', endButtonDrag);
            e.preventDefault();
        }
        
        function moveButton(e) {
            if (!draggedButton) return;
            
            const container = actionButtonsContainer;
            const dragX = e.clientX - container.getBoundingClientRect().left;
            const buttons = Array.from(container.children).filter(child => 
                child === draggedButton || 
                child.tagName === 'A' || 
                (child.tagName === 'BUTTON' && !child.classList.contains('search-toggle-btn')) ||
                child.classList.contains('search-container')
            );
            
            // Find which button to swap with
            buttons.forEach((btn, index) => {
                const rect = btn.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                const btnCenter = rect.left - containerRect.left + rect.width / 2;
                
                if (dragX < btnCenter && draggedButton !== btn) {
                    if (Array.from(container.children).indexOf(draggedButton) > Array.from(container.children).indexOf(btn)) {
                        btn.parentNode.insertBefore(draggedButton, btn);
                    }
                } else if (dragX > btnCenter && draggedButton !== btn) {
                    if (Array.from(container.children).indexOf(draggedButton) < Array.from(container.children).indexOf(btn)) {
                        btn.parentNode.insertBefore(draggedButton, btn.nextSibling);
                    }
                }
            });
        }
        
        function endButtonDrag() {
            if (!draggedButton) return;
            
            draggedButton.style.cursor = 'grab';
            draggedButton.style.opacity = '1';
            draggedButton.style.transform = 'scale(1)';
            
            // Save button order to session storage
            const order = Array.from(actionButtonsContainer.children)
                .filter(child => child.id || child.classList.length > 0)
                .map((child, idx) => ({
                    id: child.id || `btn-${idx}`,
                    html: child.outerHTML
                }));
            
            sessionStorage.setItem('actionButtonOrder', JSON.stringify(order));
            
            document.removeEventListener('mousemove', moveButton);
            document.removeEventListener('mouseup', endButtonDrag);
            draggedButton = null;
        }
        
        // Initialize drag-drop on page load
        window.addEventListener('load', function() {
            setTimeout(initButtonDragDrop, 200);
        });

        // === INTEGRATED SEARCH FUNCTIONALITY WITH DUAL MODE ===
        const searchToggleBtnMain = document.getElementById('searchToggleBtnMain');
        const searchModeBtn = document.getElementById('searchModeBtn');
        const searchInputMain = document.getElementById('searchInputMain');
        const searchSuggestionsMain = document.getElementById('searchSuggestionsMain');
        
        let searchActiveMain = false;
        let currentSearchMode = 'name';  // 'name' or 'code'
        let isFilterActive = false;  // Track if filter is applied
        let filteredResults = [];  // Store current search results
        
        // Toggle search input
        searchToggleBtnMain.addEventListener('click', function(e) {
            e.stopPropagation();
            searchActiveMain = !searchActiveMain;
            
            if (searchActiveMain) {
                searchInputMain.style.display = 'inline-block';
                searchModeBtn.style.display = 'inline-block';
                searchInputMain.focus();
            } else {
                searchInputMain.style.display = 'none';
                searchModeBtn.style.display = 'none';
                searchInputMain.value = '';
                searchSuggestionsMain.classList.remove('active');
                // Clear filter if active
                if (isFilterActive) {
                    isFilterActive = false;
                    renderTable(allLoadedPatients);
                }
                searchInputMain.blur();
            }
        });
        
        // Toggle search mode (name vs code)
        searchModeBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            if (currentSearchMode === 'name') {
                currentSearchMode = 'code';
                searchModeBtn.textContent = 'BY CODE';
                searchInputMain.placeholder = 'ENTER CODE ID...';
            } else {
                currentSearchMode = 'name';
                searchModeBtn.textContent = 'BY NAME';
                searchInputMain.placeholder = 'QUERY...';
            }
            // Clear suggestions and filter
            searchSuggestionsMain.classList.remove('active');
            if (isFilterActive) {
                isFilterActive = false;
                renderTable(allLoadedPatients);
            }
            searchInputMain.value = '';
            searchInputMain.focus();
        });
        
        // Search input handler - show suggestions on input
        searchInputMain.addEventListener('input', async function() {
            const query = this.value.trim();
            
            if (query.length < 1) {
                searchSuggestionsMain.classList.remove('active');
                return;
            }
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        search_type: currentSearchMode
                    })
                });
                
                if (response.ok) {
                    const results = await response.json();
                    displaySearchSuggestionsMain(results);
                } else {
                    searchSuggestionsMain.classList.remove('active');
                }
            } catch (e) {
                console.error('Search error:', e);
                searchSuggestionsMain.classList.remove('active');
            }
        });
        
        // Handle Enter key - apply filter
        searchInputMain.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                applySearchFilter();
            }
        });
        
        // Apply search filter to table
        async function applySearchFilter() {
            const query = searchInputMain.value.trim();
            
            if (query.length < 1) {
                renderTable(allLoadedPatients);
                isFilterActive = false;
                return;
            }
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        search_type: currentSearchMode
                    })
                });
                
                if (response.ok) {
                    const results = await response.json();
                    // Convert results to table format for display
                    // We need to fetch full patient data for these results
                    if (results.length > 0) {
                        // Get full data from loaded patients
                        filteredResults = [];
                        results.forEach(searchResult => {
                            const fullPatient = allLoadedPatients.find(p => p[0] === searchResult.id);
                            if (fullPatient) {
                                filteredResults.push(fullPatient);
                            }
                        });
                        
                        // If we found matches in loaded data, show them
                        if (filteredResults.length > 0) {
                            isFilterActive = true;
                            renderTable(filteredResults);
                            searchSuggestionsMain.classList.remove('active');
                        } else {
                            // No matches in currently loaded data
                            alert(`No results found in currently loaded records.\n\nMatches found in database but not loaded yet.\nUse "LOAD MORE RECORDS" to fetch older entries.`);
                            isFilterActive = false;
                        }
                    } else {
                        alert('NO RESULTS FOUND');
                        isFilterActive = false;
                    }
                }
            } catch (e) {
                console.error('Filter error:', e);
            }
        }
        
        // Display search suggestions - show autocomplete suggestions
        function displaySearchSuggestionsMain(results) {
            searchSuggestionsMain.innerHTML = '';
            
            if (results.length === 0) {
                const noResults = document.createElement('div');
                noResults.className = 'suggestion-item-main';
                noResults.innerHTML = 'NO RESULTS FOUND';
                noResults.style.opacity = '0.6';
                searchSuggestionsMain.appendChild(noResults);
                searchSuggestionsMain.classList.add('active');
                return;
            }
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'suggestion-item-main';
                item.innerHTML = `[${result.id}] ${result.name}`;
                item.addEventListener('click', function() {
                    // Apply filter when clicking suggestion
                    searchInputMain.value = currentSearchMode === 'code' ? result.id : result.name;
                    applySearchFilter();
                });
                
                searchSuggestionsMain.appendChild(item);
            });
            
            searchSuggestionsMain.classList.add('active');
        }
        
        // Clear filter on Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                // Clear search filter
                if (isFilterActive) {
                    isFilterActive = false;
                    renderTable(allLoadedPatients);
                    searchInputMain.value = '';
                    searchSuggestionsMain.classList.remove('active');
                }
                // Close search panel
                else if (searchActiveMain) {
                    searchToggleBtnMain.click();
                }
            }
        });
    </script>
    
    <!-- Half-Life Audio System - Valve Audio Files Integration -->
    <script src="/static/half-life-audio.js"></script>
</body>
</html>