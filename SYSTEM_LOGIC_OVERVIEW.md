# Обзор Логики Системы Симуляции Пациентов

В основе этого проекта лежит элегантное взаимодействие двух ключевых компонентов: приложения на Python, которое служит генератором хаотичных, но правдоподобных данных, и базы данных SQL, которая не только хранит эту информацию, но и содержит в себе основную логику для классификации состояния пациентов. Давайте подробно разберем, как работает эта система, от рождения нового пациента до присвоения ему статуса.

## Часть 1: Генерация Данных — «Движок Хаоса»

Центральным элементом системы является функция `chaos_engine` в файле `app.py`. Она работает в фоновом режиме, непрерывно создавая новых "пациентов" и отправляя их в базу данных. Этот процесс можно сравнить с работой приемного отделения в госпитале во время чрезвычайной ситуации, где пациенты поступают постоянно.

### Как Создается Пациент?

Каждый пациент — это набор случайно сгенерированных, но взаимосвязанных данных:

1.  **Определение Угрозы (Болезни):**
    *   Система случайным образом выбирает для пациента один из четырех "уровней угрозы" (`threat_id`). В базе данных (таблица `BioThreats`) эти идентификаторы сопоставлены с конкретными состояниями:
        *   `1`: Стабилен / Здоров
        *   `2`: Радиационное облучение
        *   `3`: Отравление токсином
        *   `4`: Критическое состояние / Шок
    *   Выбор не является равномерным. С помощью весов (`weights`) в коде, система делает некоторые состояния (например, стабильное) более вероятными, чем другие (например, критическое), что добавляет симуляции реализма.

2.  **Генерация Жизненных Показателей:**
    *   После определения угрозы, система генерирует жизненные показатели — **пульс (`HeartRate`)** и **уровень кислорода в крови (`SPO2`)**.
    *   **Логика здесь прямая:** чем выше уровень угрозы, тем более критическими будут показатели. Например, у "здорового" пациента (`threat_id = 1`) пульс будет в пределах нормы (например, 60-100 ударов в минуту), а у пациента в критическом состоянии (`threat_id = 4`) пульс может быть аномально высоким или низким, а сатурация кислорода — опасно низкой. Это достигается путем установки разных диапазонов для случайной генерации чисел в зависимости от `threat_id`.

3.  **Распределение по Палатам и Врачам:**
    *   Система имитирует распределение ресурсов госпиталя. Каждому новому пациенту случайным образом назначается:
        *   **Палата:** Выбирается случайный `room_id` от 1 до 6. В базе данных есть таблица `Rooms` с названиями этих палат (например, "Палата A-1", "Палата B-2").
        *   **Врач:** Выбирается случайный `doctor_id` от 1 до 20. Аналогично, в таблице `Doctors` хранятся имена всех врачей.
    *   **Важный момент:** на данном этапе логика распределения чисто случайна. Система не анализирует загруженность палат или врачей. Это симуляция базового, автоматического распределения при массовом поступлении.

## Часть 2: Классификация — «Логика Цвета»

Самый интересный аспект — как система присваивает пациенту цветовую категорию (зеленый, желтый, красный, черный), что является стандартом медицинской сортировки (триаж).

### Где Происходят Вычисления?

Вопреки ожиданиям, эта логика реализована **не в Python-коде, а непосредственно в базе данных SQL**. В таблице `Subjects`, где хранятся данные о пациентах, есть специальное вычисляемое поле (`computed column`) под названием `StatusColor`.

### Алгоритм Классификации

Логика предельно проста и эффективна. Она напрямую связывает `AssignedThreatID` (уровень угрозы, присвоенный при создании пациента) с цветом:

*   Если `AssignedThreatID` = **1** (Здоров), `StatusColor` становится **'Green'** (Зеленый).
*   Если `AssignedThreatID` = **2** (Радиация), `StatusColor` становится **'Yellow'** (Желтый).
*   Если `AssignedThreatID` = **3** (Токсин), `StatusColor` становится **'Red'** (Красный).
*   Если `AssignedThreatID` = **4** (Критика), `StatusColor` становится **'Black'** (Черный).

**Пример:**
1.  `chaos_engine` создает пациента.
2.  Ему присваивается `threat_id = 3`.
3.  Жизненные показатели генерируются в красной зоне (например, высокий пульс, низкая сатурация).
4.  Случайным образом ему назначаются палата №5 и доктор №12.
5.  Когда эта запись попадает в таблицу `Subjects`, база данных автоматически, без участия Python, смотрит на `AssignedThreatID = 3` и вычисляет значение для поля `StatusColor` как `Red`.

### Почему Было Выбрано Такое Решение?

Перенос этой логики из кода приложения в базу данных — это осознанное и грамотное архитектурное решение.

*   **Производительность:** Вычисления на стороне базы данных для таких простых правил работают чрезвычайно быстро. Это снижает нагрузку на приложение Python.
*   **Централизация Логики:** "Единый источник правды" для классификации находится в одном месте — в схеме данных. Любое приложение или сервис, которое будет работать с этой базой, будет использовать ту же самую логику, что обеспечивает консистентность.
*   **Простота и Надежность:** Вместо того чтобы писать в Python код с условиями `if/elif/else`, используется декларативный подход SQL. Это делает логику более читаемой и менее подверженной ошибкам.

Интересно, что в файле `sql` можно найти остатки более старой, сложной системы, которая использовала триггер и "оценку летальности" (`LethalityScore`) для вычисления статуса. Текущая реализация — это значительное упрощение, которое сделало систему более предсказуемой и быстрой, пожертвовав гибкостью ради эффективности, что часто является верным выбором для высоконагруженных систем.

## Заключение

Таким образом, система представляет собой симулятор, где **Python (`app.py`) отвечает за "что"** (создание пациентов и их характеристик), а **база данных (`sql`) отвечает за "как"** (хранение и, что самое главное, автоматическая классификация этих пациентов). Случайная генерация данных в `chaos_engine` обеспечивает динамику, а жесткая логика в SQL — порядок и структуру.